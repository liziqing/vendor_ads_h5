define(["base/env","base/util","base/wechat/wx","jquery"],function(e,t,n,a){function r(e){if("object"!=typeof e)return e;var t={};e.constructor==Array&&(t=[]);for(var n in e)t[n]=r(e[n]);return t}function d(e,t,n,a,r,d){return"undefined"==typeof e?void alert("你还没有配置APP ID"):void WeixinJSBridge.invoke("getBrandWCPayRequest",{appId:e,timeStamp:n,nonceStr:t,package:a,signType:d,paySign:r},function(e){"get_brand_wcpay_request:ok"==e.err_msg?c=setTimeout(function(){m=0,i()},1e3):s.fail(e)})}function i(){if("undefined"==typeof x.charge_id)return void alert("没有获取到交易id。");var e=(x.charge_id,s.queryChargeUrl);return"undefined"==typeof e?void alert("你还没有配置查询订单接口。"):"undefined"==typeof s.success?void alert("你还没有配置成功页或回调方法。"):(x.format="jsonp",void t.ajax({url:e,type:"get",data:x,dataType:"jsonp",success:function(e){t.closeAlertx(),0==e.code&&1==e.data.paid?"string"==typeof s.success?window.location.href=s.success:"function"==typeof s.success&&s.success(e):++m<g?i():clearTimeout(c)},error:function(e){t.closeAlertx(),alert("数据读取失败")}}))}function o(){u=!0}var c,s={},u=!1,p=!1,l=navigator.userAgent.toLowerCase(),f=null,y=null,g=5,m=0,x={},h=null,s=function(t){if("undefined"!=typeof t.queryChargeUrl&&(s.queryChargeUrl=t.queryChargeUrl),"undefined"!=typeof t.success&&(s.success=t.success),"undefined"!=typeof t.fail&&(s.fail=t.fail),"undefined"!=typeof t.appId&&(s.appId=t.appId),"undefined"!=typeof t.editAddr&&(s.editAddr=t.editAddr,1==s.editAddr)){if("undefined"==typeof t.editAddrCallback)return void alert("你还没有配置修改地址成功的回调方法。");s.editAddrCallback=t.editAddrCallback}"undefined"!=typeof t.maxAttempt&&(g=t.maxAttempt),"undefined"!=typeof t.createChargeUrl?s.createChargeUrl=t.createChargeUrl:s.createChargeUrl="http://"+e.h5domain+"/proxy/weixin/pay/create-charge","undefined"!=typeof t.callback&&(h=t.callback),n.initTokenNoSession(t.appId,window.location.href,v)},v=function(e){f=e.access_token,y=e.openid,null!=h&&h()},A=function(e,n){n=n||s.createChargeUrl,"undefined"==typeof n&&alert("你还没有配置创建交易接口。"),e=e||{},e.open_id=y,e.format="jsonp",1==u&&S()>=5&&(t.alertx("支付提交中，请耐心等待"),t.ajax({url:n,type:"post",data:e,dataType:"jsonp",success:function(e){if(t.closeAlertx(),0==e.code){var n=e.data.nonce_str,a=e.data.timestamp,i=e.data.package_str,o=e.data.pay_sign,c=e.data.sign_type;x=r(e.data),delete x.nonce_str,delete x.timestamp,delete x.package_str,delete x.pay_sign,delete x.sign_type,p=!1,d(s.appId,n,a,i,o,c)}else alert(e.message)},error:function(e){t.closeAlertx(),alert("数据读取失败")}}))},_=function(){u&&S()>=5&&(t.alertx("请耐心等待"),null!=f&&k(s.appId,f,window.location.href))},k=function(n,a,r){t.ajax({url:"http://"+e.domain+"/weixin/common/edit-addr-params",type:"get",data:{url:encodeURIComponent(r),token:a,format:"jsonp"},dataType:"jsonp",success:function(e){if(0==e.code){var t=s.appId,n="jsapi_address",a="sha1",r=e.data.signature,d=e.data.timestamp,i=e.data.nonceStr;C(t,n,a,r,d,i)}else alert(e.message)},error:function(e){t.closeAlertx(),alert("数据读取失败")}})},C=function(e,n,a,r,d,i){t.closeAlertx(),WeixinJSBridge.invoke("editAddress",{appId:e,scope:n,signType:a,addrSign:r,timeStamp:d,nonceStr:i},function(e){"edit_address:ok"==e.err_msg&&s.editAddrCallback(e)})},S=function(){var e=/(micromessenger)[ \/]([\w.]+)/,t=e.exec(l)||[],n=t[2]||"0";return parseFloat(n)};return a(function(){"undefined"==typeof WeixinJSBridge?document.addEventListener?document.addEventListener("WeixinJSBridgeReady",o,!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",o),document.attachEvent("onWeixinJSBridgeReady",o)):o()}),{config:s,editAddr:_,pay:A}});